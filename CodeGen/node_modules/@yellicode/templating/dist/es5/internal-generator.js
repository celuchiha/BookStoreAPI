/*
 * Copyright (c) 2019 Yellicode
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at http://mozilla.org/MPL/2.0/.
 */
import * as path from 'path';
import * as fs from 'fs';
import { ModelReader } from '@yellicode/elements';
import { StreamWriter } from './stream-writer';
import { FileSystemUtility } from './file-system-utility';
import { OutputMode } from './options';
import { ToHostLogger } from './to-host-logger';
var InternalGenerator = /** @class */ (function () {
    function InternalGenerator() {
        this.outputMode = OutputMode.Overwrite;
        this.modelBuilderResult = null;
        this.modelBuilderPromise = null;
        this.parseProcessArgs(process.argv);
        var startedMessage = { cmd: 'processStarted' };
        this.sendProcessMessage(startedMessage);
        this.logger = new ToHostLogger();
    }
    InternalGenerator.prototype.parseProcessArgs = function (args) {
        for (var index = 0; index < args.length; index++) {
            var val = args[index];
            if (val === '--templateArgs') {
                this.templateArgs = InternalGenerator.parseTemplateArgs(args, index);
            }
            else if (val === '--outputMode') {
                this.outputMode = InternalGenerator.parseOutputMode(args, index) || this.outputMode;
            }
        }
    };
    InternalGenerator.parseOutputMode = function (args, index) {
        if (args.length <= index + 1)
            return null;
        var outputModeString = args[index + 1];
        switch (outputModeString) {
            case 'append':
                return OutputMode.Append;
            case 'once':
                return OutputMode.Once;
            case 'overwrite':
                return OutputMode.Overwrite;
            default:
                return null;
        }
    };
    InternalGenerator.parseTemplateArgs = function (args, index) {
        if (args.length <= index + 1)
            return null;
        var templateArgsString = args[index + 1];
        if (templateArgsString.length > 0) {
            return JSON.parse(templateArgsString);
        }
        return null;
    };
    InternalGenerator.prototype.sendProcessMessage = function (message) {
        process.send(message); // https://github.com/Microsoft/TypeScript/issues/10158        
    };
    InternalGenerator.prototype.generate = function (options, template) {
        this.generateInternal(options, function (writer) {
            template(writer);
            return Promise.resolve();
        });
    };
    InternalGenerator.prototype.generateAsync = function (options, template) {
        this.generateInternal(options, template);
    };
    /**
     * Executes the provided template using the model that was configured in the code generation configuration.
     */
    InternalGenerator.prototype.generateFromModel = function (options, template) {
        var _this = this;
        this.getModel(options)
            .then(function (model) {
            _this.generateInternal(options, function (writer) {
                template(writer, model);
                return Promise.resolve();
            });
        }).catch(function (err) {
            console.log(err);
        });
    };
    InternalGenerator.prototype.generateFromModelAsync = function (options, template) {
        var _this = this;
        this.getModel(options)
            .then(function (model) {
            _this.generateInternal(options, function (writer) {
                return template(writer, model);
            });
        }).catch(function (err) {
            console.log(err);
        });
    };
    InternalGenerator.prototype.generateInternal = function (options, callback) {
        var _this = this;
        // Get the working directory. The host will make sure that this is the directory in which the template resides.
        var templateDirName = path.resolve('./');
        // console.log('Generator: Template directory name is \'%s\'', templateDirName);
        var fullOutputFileName = path.join(templateDirName, options.outputFile);
        // Ensure that the directory exists        
        FileSystemUtility.ensureDirectory(path.dirname(fullOutputFileName));
        // Let the host know that we started something so that we don't get killed
        var startedMessage = { cmd: 'generateStarted' };
        this.sendProcessMessage(startedMessage);
        // console.log('Generator: Generating file \'%s\'...', fullOutputFileName);
        var mode = options.outputMode === undefined ? this.outputMode : options.outputMode;
        if (mode === OutputMode.Once && fs.existsSync(fullOutputFileName)) {
            // Don't regenerate the file
            var finishedMessage = { cmd: 'generateFinished' };
            this.sendProcessMessage(finishedMessage);
            return;
        }
        var flags = mode === OutputMode.Append ? 'a' : 'w';
        var writeStream = fs.createWriteStream(fullOutputFileName, { flags: flags });
        writeStream.once('open', function (fd) {
            var cw = new StreamWriter(writeStream, options.regionMarkerFormatter);
            callback(cw)
                .then(function () {
                writeStream.end();
                // console.log('Generator: Finished generating \'%s\'...', fullOutputFileName);
                // Let the host know that we are done
                var finishedMessage = { cmd: 'generateFinished' };
                _this.sendProcessMessage(finishedMessage);
            });
        });
    };
    /**
    * Loads the model that was configured in the code generation configuration.
    */
    InternalGenerator.prototype.getModel = function (options) {
        var codeModelOptions = options || {};
        var parseJson = codeModelOptions.noParse !== true;
        if (this.modelBuilderResult || this.modelBuilderPromise) {
            return this.getModelFromModelBuilder(options);
        }
        var promise = new Promise(function (resolve, reject) {
            process.on('message', function (m) {
                if (m.cmd !== 'setModel') {
                    return;
                }
                if (!m.modelData) {
                    return reject('The host returned an empty model. Please make sure that a model has been configured for this template.');
                }
                var model;
                // Should we parse the model into a Yellicode model?                                
                if (parseJson && ModelReader.canRead(m.modelData)) {
                    // The modelData will contain a Yellicode document with two main nodes: a 'model' node and an optional 'profiles' node.
                    // We need to parse the entire document (because profiles must be applied) and then return
                    // just the model part.
                    var document_1 = ModelReader.readDocument(m.modelData);
                    if (document_1) {
                        model = document_1.model;
                    }
                    else
                        model = null;
                }
                else
                    model = m.modelData; // return plain JSON
                // Apply transforms                
                var targetModel;
                if (model && codeModelOptions.modelTransform) {
                    targetModel = codeModelOptions.modelTransform.transform(model);
                }
                else
                    targetModel = model;
                resolve(targetModel);
            });
        });
        var getModelMessage = { cmd: 'getModel' };
        this.sendProcessMessage(getModelMessage);
        return promise;
    };
    InternalGenerator.prototype.getModelFromModelBuilder = function (options) {
        var codeModelOptions = options || {};
        var applyTransform = function (model) {
            if (model && codeModelOptions.modelTransform) {
                return codeModelOptions.modelTransform.transform(model);
            }
            return model;
        };
        if (this.modelBuilderResult) {
            // this.logger.verbose('getModelFromModelBuilder: returning current modelBuilderResult.');            
            return Promise.resolve(applyTransform(this.modelBuilderResult));
        }
        else if (this.modelBuilderPromise) {
            // this.logger.verbose('getModelFromModelBuilder: waiting for modelBuilderPromise.');
            return this
                .modelBuilderPromise
                .then((function (m) {
                // this.logger.verbose('getModelFromModelBuilder: modelBuilderPromise done.');
                return applyTransform(m);
            }));
        }
        else
            return Promise.reject('An unexpected internal error has occured.'); // either modelBuilderResult or modelBuilderPromise will have a value, see getModel
    };
    InternalGenerator.prototype.buildModel = function (builder) {
        var _this = this;
        // We need to signal the CLI that we started something async and that is should not kill us.
        // Use the 'generateStarted' / 'generateFinished' commands for now, although we should really use a different command.        
        this.logger.verbose("Generator.buildModel starting...");
        this.sendProcessMessage({ cmd: 'generateStarted' });
        // Set up a promise to be returned to the caller, althoug it is optional to use it.
        var resolveFunctionPromise;
        var rejectFunctionPromise;
        var functionPromise = new Promise(function (resolve, reject) {
            // resolve when builder resolves
            resolveFunctionPromise = resolve;
            rejectFunctionPromise = reject;
        });
        this.modelBuilderResult = null;
        this.modelBuilderPromise = builder()
            .then(function (result) {
            _this.modelBuilderResult = result;
            // var d2 = new Date();
            // this.logger.verbose(`${d2.getMinutes()}:${d2.getMilliseconds()}: buildModel finished`);
            _this.logger.verbose("Generator.buildModel finished.");
            resolveFunctionPromise(result);
            // Let the host know that we are 'done'                
            _this.sendProcessMessage({ cmd: 'generateFinished' });
            return result;
        })
            .catch(function (e) { return rejectFunctionPromise(e); });
        return functionPromise;
    };
    return InternalGenerator;
}());
export var Generator = new InternalGenerator();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW50ZXJuYWwtZ2VuZXJhdG9yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2ludGVybmFsLWdlbmVyYXRvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7O0dBTUc7QUFFSCxPQUFPLEtBQUssSUFBSSxNQUFNLE1BQU0sQ0FBQztBQUM3QixPQUFPLEtBQUssRUFBRSxNQUFNLElBQUksQ0FBQztBQUV6QixPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFFbEQsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBRS9DLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBRTFELE9BQU8sRUFBRSxVQUFVLEVBQTRFLE1BQU0sV0FBVyxDQUFDO0FBQ2pILE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUVoRDtJQU9JO1FBTFEsZUFBVSxHQUFlLFVBQVUsQ0FBQyxTQUFTLENBQUM7UUFDOUMsdUJBQWtCLEdBQWUsSUFBSSxDQUFDO1FBQ3RDLHdCQUFtQixHQUF3QixJQUFJLENBQUM7UUFJcEQsSUFBSSxDQUFDLGdCQUFnQixDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNwQyxJQUFNLGNBQWMsR0FBb0IsRUFBRSxHQUFHLEVBQUUsZ0JBQWdCLEVBQUUsQ0FBQztRQUNsRSxJQUFJLENBQUMsa0JBQWtCLENBQUMsY0FBYyxDQUFDLENBQUM7UUFDeEMsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLFlBQVksRUFBRSxDQUFDO0lBQ3JDLENBQUM7SUFFTyw0Q0FBZ0IsR0FBeEIsVUFBeUIsSUFBYztRQUNuQyxLQUFLLElBQUksS0FBSyxHQUFHLENBQUMsRUFBRSxLQUFLLEdBQUcsSUFBSSxDQUFDLE1BQU0sRUFBRSxLQUFLLEVBQUUsRUFBRTtZQUM5QyxJQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7WUFD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